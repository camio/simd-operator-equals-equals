---
title: "`std::simd` Objects Should be Value Semantic"
document: D2892R0
date: 2023-05-16
audience: Library Evolution
author:
  - name: Joe Jevnik
    email: <joejev@gmail.com>
  - name: David Sankel
    email: <dsankel@adobe.com>
toc: false

---

# Abstract

Abstract goes here

::: cmptable

### Before

```cpp
Some Code
```

### After

```cpp
Some Code
```

:::

# Introduction

Set context:

- std::simd being proposed for standardization
- Discussions at C++Now conference. Point out the poll numbers
- Point out benefits of value semantics for std::simd types
- Point out status quo that we are trying to change

# Value semantics and its advantages

- Introduce value semantics
- Discuss C++ rendering
- Discuss advantages of uniform treatment

# std::simd types and value semantics

- Provide the two examples
- Show frustration at failure points

# Existing practice

There exists many libraries which wrap SIMD operations today.
Some libraries more explicitly wrap a single SIMD register, like VCL or xsimd,  where others express larger arrays or mathematical objects.
The following table covers some open source libraries and their choices with respect to comparison operators.

| Library                            | Comparison Behavior                                              |
| ---------------------------------- | ---------------------------------------------------------------- |
| Armadillo                          | Element-wise                                                     |
| Blaze                              | Regular                                                          |
| EVE                                | Element-wise                                                     |
| Eigen::Array                       | Element-wise                                                     |
| Eigen::{Matrix, RowVector, Vector} | Regular                                                          |
| Fastor                             | Element-wise                                                     |
| VCL                                | Element-wise                                                     |
| xsimd                              | Element-wise                                                     |
| xtensor                            | Regular `operator==` and `operator!=`; rest are element-wise[^1] |

## Wrappers and DSLs

These libraries exist broadly in two categories: wrappers around SIMD operations and DSLs (domain specific languages) for doing math and multidimensional array operations.
For libraries that are conceptually DSLs: users are unlikely to switch away from these high level tools.
If end users want to use a DSL, they will be shielded from the particular syntactic choices used by `std::simd` and this is an irrelevant decision for them.

For users who want to introduce a small amount of data parallelism in their code, or are implementers of a DSL, having regular comparison will fit more naturally into rest of the C++ language for the reasons stated above.
Non-DSL users will still see a considerable benefit with respect to conciseness and clarity over using platform specific intrinsic operations, even with value-semantics.
For example if we compare one of the algorithms in [@P1928R3] which used element-wise `operator>=`, the new proposal is not considerably more verbose nor unclear:

```diff
 using floatv = std::simd<float>
 using intv = std::rebind_simd_t<int, floatv>;

 int count_positive(const std::vector<floatv>& xs) {
     // simplify generated assembly:
     if (x.size() == 0) std::unreachable();
     intv counter = {};
     for (std::simd x : xs) {
-        counter += x > 0;
+        counter += @_greater_@(x, 0);
     }
     return reduce(counter);
 }
```

# Conclusion

Stuffies...

[^1]: This option is only used in xtensor, not even the related project xsimd.
      The inconsistency seems more likely to cause bugs than selecting either behavior by itself.

---
references:
  - id: P1928R3
    citation-label: P1928R3
    title: "Merge Data-Parallel Types From the Parallelism TS 2"
    author:
      - family: Kretz
        given: Matthias
    issued:
      year: 2023
    url: http://wg21.link/P1928R3
---
